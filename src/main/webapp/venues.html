<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <title>Ticket IS · Venues</title>
    <style>
        :root{
            --bg:#f4f6fa; --card:#ffffff; --text:#101828; --muted:#667085; --border:#8ea0b8;
            --shadow:0 10px 30px rgba(16,24,40,.08); --shadow2:0 4px 14px rgba(16,24,40,.08);
            --radius:16px; --accent:#ffcc00; --danger:#ef4444; --focus:0 0 0 3px rgba(255,204,0,.35);
            --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        }
        *{ box-sizing:border-box; }
        body{ margin:0; font-family:var(--font); color:var(--text); background:var(--bg); }
        .app{ max-width: 1320px; margin:0 auto; padding:18px 16px 40px; }
        .topbar{
            display:flex; align-items:center; justify-content:space-between; gap:12px;
            padding:14px 16px; background:var(--card); border:1px solid var(--border);
            border-radius:var(--radius); box-shadow:var(--shadow2);
        }
        .brand{ display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px; }
        .brand-badge{ width:34px; height:34px; border-radius:10px; background:var(--accent); display:grid; place-items:center; font-weight:900; }
        .hint{ color:var(--muted); font-size:13px; }
        .nav{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
        .nav a{ text-decoration:none; color:var(--text); padding:10px 12px; border-radius:12px; border:1px solid transparent; }
        .nav a:hover{ background:#f8fafc; border-color:var(--border); }
        .nav a.active{ background:#111827; color:#fff; }
        .grid{ display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px; }
        .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow2); padding:14px; }
        .card-title{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
        .card-title h1{ font-size:18px; margin:0; }
        .row{ display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; }
        .field{
            min-width:180px;
            display:flex;
            flex-direction:column;
            gap:6px;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: #fff;
        }
        .field label{ font-size:12px; color:var(--muted); }
        input, select, textarea{ width:100%; border:1px solid #7f91ab; border-radius:12px; padding:10px 12px; background:#fff; outline:none; }
        input:focus, select:focus, textarea:focus{ box-shadow:var(--focus); border-color:#f0c419; }
        .btn{
            border:1px solid #7487a2; background:#fff; color:var(--text);
            padding:10px 12px; border-radius:12px; cursor:pointer;
        }
        .btn:hover{ background:#f8fafc; }
        .btn.primary{ background:var(--accent); border-color:#d0aa00; color:#111827; font-weight:700; }
        .btn.dark{ background:#111827; color:#fff; border-color:#111827; }
        .btn.danger{ background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.25); color:var(--danger); }
        .pager{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
        .pill{ padding:8px 10px; border:1px solid var(--border); background:#fff; border-radius:999px; color:var(--muted); font-size:13px; }
        table{
            width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;
            border-radius:14px; border:1px solid var(--border);
        }
        thead th{
            position:sticky; top:0; background:#f8fafc; border-bottom:1px solid var(--border);
            font-size:12px; color:var(--muted); text-align:left; padding:10px 10px; cursor:pointer; user-select:none; white-space:nowrap;
        }
        tbody td{ padding:10px 10px; border-bottom:1px solid var(--border); font-size:13px; vertical-align:top; }
        tbody tr:nth-child(even){ background:#fcfdff; }
        tbody tr:hover{ background:#f6f8ff; }
        .actions{ display:flex; gap:8px; flex-wrap:wrap; }
        pre#log{ margin:0; color:var(--danger); font-size:12px; white-space:pre-wrap; }

        dialog{ border:none; border-radius:18px; padding:0; width:min(760px, calc(100% - 24px)); box-shadow:var(--shadow); }
        dialog::backdrop{ background:rgba(16,24,40,.35); backdrop-filter: blur(2px); }
        .dlg{ padding:14px; }
        .dlg-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 14px 10px; border-bottom:1px solid var(--border); }
        .dlg-head h3{ margin:0; font-size:16px; }
        .dlg-body{ padding:12px 14px 14px; }
        .dlg-foot{ padding:12px 14px 14px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; }
        .two{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        @media (max-width: 900px){ .two{ grid-template-columns:1fr; } .field{ min-width:140px; } }
    </style>
</head>
<body>
<div class="app">
    <div class="topbar">
        <div class="brand">
            <div class="brand-badge">T</div>
            <div>
                Ticket IS
                <div class="hint">Venues</div>
            </div>
        </div>
        <div class="nav">
            <a href="./index.html">Tickets</a>
            <a class="active" href="./venues.html">Venues</a>
            <a href="./persons.html">Persons</a>
            <a href="./events.html">Events</a>
            <button class="btn" id="logoutBtn" type="button">Logout</button>
        </div>
    </div>

    <div class="grid">
            <div class="card">
                <div class="card-title">
                    <h1>Venues</h1>
                    <button class="btn primary" id="createBtn">Create venue</button>
                </div>

                <div class="row" style="margin-bottom:10px;">
                    <div class="field">
                        <label>Name (exact)</label>
                        <input id="fName" placeholder="Exact name">
                    </div>
                    <div class="field">
                        <label>id</label>
                        <input id="fId" type="number" min="1" placeholder="Exact id">
                    </div>
                    <div class="field">
                        <label>Type (exact)</label>
                        <select id="fType">
                            <option value="">any</option>
                            <option>BAR</option><option>THEATRE</option><option>CINEMA</option><option>MALL</option><option>STADIUM</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>zipCode (exact)</label>
                        <input id="fZip" placeholder="Exact zipCode">
                    </div>
                    <div class="field">
                        <label>capacity</label>
                        <input id="fCapacity" type="number" min="1" placeholder="Exact capacity">
                    </div>
                    <div class="field">
                        <label>town.x</label>
                        <input id="fTownX" type="number" step="0.01" placeholder="Exact x">
                    </div>
                    <div class="field">
                        <label>town.y</label>
                        <input id="fTownY" type="number" step="0.01" placeholder="Exact y">
                    </div>
                    <div class="field">
                        <label>town.z</label>
                        <input id="fTownZ" type="number" step="0.01" placeholder="Exact z">
                    </div>
                    <button class="btn" id="applyFiltersBtn">Apply filters</button>
                    <button class="btn" id="clearFiltersBtn">Clear filters</button>
                </div>

                <div class="row" style="justify-content: space-between; margin-bottom:10px;">
                    <div class="pager">
                        <button class="btn" id="prevBtn">Prev</button>
                        <button class="btn" id="nextBtn">Next</button>
                    <span class="pill" id="pageInfo"></span>
                </div>

                <div class="row">
                    <div class="field" style="min-width:160px;">
                        <label>Sort</label>
                        <select id="sortSel">
                            <option value="id">id</option>
                            <option value="name">name</option>
                            <option value="capacity">capacity</option>
                            <option value="type">type</option>
                            <option value="zipCode">zipCode</option>
                            <option value="townX">townX</option>
                            <option value="townY">townY</option>
                            <option value="townZ">townZ</option>
                        </select>
                    </div>
                    <div class="field" style="min-width:160px;">
                        <label>Order</label>
                        <select id="orderSel">
                            <option value="asc">asc</option>
                            <option value="desc">desc</option>
                        </select>
                    </div>
                    <div class="field" style="min-width:140px;">
                        <label>Page size</label>
                        <select id="pageSize">
                            <option>5</option>
                            <option selected>20</option>
                            <option>50</option>
                        </select>
                    </div>
                    <button class="btn" id="applyBtn">Apply</button>
                </div>
            </div>

            <table>
                <thead>
                <tr>
                    <th data-sort="id">id</th>
                    <th data-sort="name">name</th>
                    <th data-sort="capacity">capacity</th>
                    <th data-sort="type">type</th>
                    <th data-sort="zipCode">address.zipCode</th>
                    <th data-sort="townX">town (x,y,z)</th>
                    <th>actions</th>
                </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>

            <div style="margin-top:10px;">
                <pre id="log"></pre>
            </div>
        </div>
    </div>
</div>

<dialog id="editDlg">
    <div class="dlg">
        <div class="dlg-head">
            <h3 id="dlgTitle">Venue</h3>
            <button class="btn" onclick="document.getElementById('editDlg').close('cancel')">Close</button>
        </div>

        <form method="dialog" id="editForm">
            <div class="dlg-body">
                <input type="hidden" id="vId">
                <div class="two">
                    <div class="field">
                        <label>Name</label>
                        <input id="vName" required>
                    </div>
                    <div class="field">
                        <label>Capacity (>0)</label>
                        <input id="vCapacity" type="number" min="1" required>
                    </div>
                    <div class="field">
                        <label>Type</label>
                        <select id="vType" required>
                            <option>BAR</option><option>THEATRE</option><option>CINEMA</option><option>MALL</option><option>STADIUM</option>
                        </select>
                    </div>

                    <div class="field">
                        <label>Address.zipCode (optional, len>=7)</label>
                        <input id="vZip" placeholder="optional">
                    </div>

                    <div class="field">
                        <label>Address.town.x (optional Float)</label>
                        <input id="vTownX" type="number" step="0.01" placeholder="optional">
                    </div>
                    <div class="field">
                        <label>Address.town.y (optional float)</label>
                        <input id="vTownY" type="number" step="0.01" placeholder="optional">
                    </div>
                    <div class="field">
                        <label>Address.town.z (optional Float)</label>
                        <input id="vTownZ" type="number" step="0.01" placeholder="optional">
                    </div>
                </div>
            </div>

            <div class="dlg-foot">
                <button class="btn" value="cancel">Cancel</button>
                <button class="btn primary" value="default">Save</button>
            </div>
        </form>
    </div>
</dialog>

<script>
    function ctx() {
        const p = location.pathname.split('/');
        return p.length > 1 ? '/' + p[1] : '';
    }

    async function ensureAuth() {
        const r = await fetch(`${ctx()}/api/auth/me`);
        if (r.status === 401) {
            location.href = `${ctx()}/login.html`;
            return false;
        }
        return r.ok;
    }

    async function logout() {
        await fetch(`${ctx()}/api/auth/logout`, { method: 'POST' });
        location.href = `${ctx()}/login.html`;
    }

    const state = { page: 0, size: 20, sort: 'id', order: 'asc', id: '', name: '', type: '', zipCode: '', capacity: '', townX: '', townY: '', townZ: '' };
    const log = (msg) => document.getElementById('log').textContent = msg;

    async function fetchPage() {
        const qs = new URLSearchParams();
        qs.set('page', state.page);
        qs.set('size', state.size);
        qs.set('sort', state.sort);
        qs.set('order', state.order);
        if (state.id) qs.set('id', state.id);
        if (state.name) qs.set('name', state.name);
        if (state.type) qs.set('type', state.type);
        if (state.zipCode) qs.set('zipCode', state.zipCode);
        if (state.capacity) qs.set('capacity', state.capacity);
        if (state.townX) qs.set('townX', state.townX);
        if (state.townY) qs.set('townY', state.townY);
        if (state.townZ) qs.set('townZ', state.townZ);
        const url = `${ctx()}/api/venues?${qs.toString()}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
    }

    function render(pageDto) {
        const tb = document.getElementById('tbody');
        tb.innerHTML = '';
        for (const v of pageDto.items) {
            const zip = v.address?.zipCode ?? '';
            const town = v.address?.town
                ? `${v.address.town.x}, ${v.address.town.y}, ${v.address.town.z}`
                : '';
            const tr = document.createElement('tr');
            tr.innerHTML = `
        <td>${v.id}</td>
        <td>${v.name}</td>
        <td>${v.capacity}</td>
        <td>${v.type}</td>
        <td>${zip}</td>
        <td>${town}</td>
        <td>
          <div class="actions">
            <button class="btn" data-act="edit" data-id="${v.id}">Edit</button>
            <button class="btn danger" data-act="del" data-id="${v.id}">Delete</button>
          </div>
        </td>
      `;
            tb.appendChild(tr);
        }
        document.getElementById('pageInfo').textContent =
            `page=${pageDto.page}, size=${pageDto.size}, total=${pageDto.total}`;
    }

    async function reload() {
        try {
            const data = await fetchPage();
            render(data);
            log('');
        } catch (e) {
            log(String(e));
        }
    }

    document.getElementById('prevBtn').onclick = () => { if (state.page > 0) state.page--; reload(); };
    document.getElementById('nextBtn').onclick = () => { state.page++; reload(); };
    document.getElementById('pageSize').onchange = (e) => { state.size = parseInt(e.target.value, 10); state.page = 0; reload(); };
    document.getElementById('applyBtn').onclick = () => {
        state.sort = document.getElementById('sortSel').value;
        state.order = document.getElementById('orderSel').value;
        state.page = 0;
        reload();
    };
    document.getElementById('applyFiltersBtn').onclick = () => {
        state.id = document.getElementById('fId').value.trim();
        state.name = document.getElementById('fName').value.trim();
        state.type = document.getElementById('fType').value;
        state.zipCode = document.getElementById('fZip').value.trim();
        state.capacity = document.getElementById('fCapacity').value.trim();
        state.townX = document.getElementById('fTownX').value.trim();
        state.townY = document.getElementById('fTownY').value.trim();
        state.townZ = document.getElementById('fTownZ').value.trim();
        state.page = 0;
        reload();
    };
    document.getElementById('clearFiltersBtn').onclick = () => {
        document.getElementById('fId').value = '';
        document.getElementById('fName').value = '';
        document.getElementById('fType').value = '';
        document.getElementById('fZip').value = '';
        document.getElementById('fCapacity').value = '';
        document.getElementById('fTownX').value = '';
        document.getElementById('fTownY').value = '';
        document.getElementById('fTownZ').value = '';
        state.id = '';
        state.name = '';
        state.type = '';
        state.zipCode = '';
        state.capacity = '';
        state.townX = '';
        state.townY = '';
        state.townZ = '';
        state.page = 0;
        reload();
    };

    document.querySelectorAll('th[data-sort]').forEach(th => {
        th.onclick = () => {
            const s = th.getAttribute('data-sort');
            if (state.sort === s) state.order = (state.order === 'asc' ? 'desc' : 'asc');
            else { state.sort = s; state.order = 'asc'; }
            document.getElementById('sortSel').value = state.sort;
            document.getElementById('orderSel').value = state.order;
            reload();
        };
    });

    const dlg = document.getElementById('editDlg');
    function openDialog(v) {
        document.getElementById('vId').value = v?.id ?? '';
        document.getElementById('dlgTitle').textContent = v?.id ? `Edit venue ${v.id}` : 'Create venue';
        document.getElementById('vName').value = v?.name ?? '';
        document.getElementById('vCapacity').value = v?.capacity ?? 1;
        document.getElementById('vType').value = v?.type ?? 'BAR';
        document.getElementById('vZip').value = v?.address?.zipCode ?? '';
        document.getElementById('vTownX').value = v?.address?.town?.x ?? '';
        document.getElementById('vTownY').value = v?.address?.town?.y ?? '';
        document.getElementById('vTownZ').value = v?.address?.town?.z ?? '';
        dlg.showModal();
    }

    document.getElementById('createBtn').onclick = () => openDialog(null);

    document.getElementById('tbody').onclick = async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-act');

        if (act === 'del') {
            if (!confirm(`Delete venue ${id}?`)) return;

            let r = await fetch(`${ctx()}/api/venues/${id}`, { method: 'DELETE' });

            if (!r.ok) {
                const newId = prompt(`Venue ${id} is used by tickets.\nEnter newVenueId to rebind tickets and delete:`);
                if (!newId) return;

                r = await fetch(`${ctx()}/api/venues/${id}/rebind-delete?newVenueId=${encodeURIComponent(newId)}`, {
                    method: 'POST'
                });

                if (!r.ok) alert(`rebind-delete failed: ${r.status}\n${await r.text()}`);
            }
            reload();
        }


        if (act === 'edit') {
            const r = await fetch(`${ctx()}/api/venues/${id}`);
            if (!r.ok) { alert(`load failed: ${r.status}`); return; }
            const v = await r.json();
            openDialog(v);
        }
    };

    document.getElementById('editForm').onsubmit = async () => {
        const id = document.getElementById('vId').value.trim();

        const zip = document.getElementById('vZip').value.trim();
        const tx = document.getElementById('vTownX').value.trim();
        const ty = document.getElementById('vTownY').value.trim();
        const tz = document.getElementById('vTownZ').value.trim();

        const address = {
            zipCode: zip ? zip : null,
            town: (tx || ty || tz) ? {
                x: tx ? parseFloat(tx) : null,
                y: ty ? parseFloat(ty) : 0.0,
                z: tz ? parseFloat(tz) : null
            } : null
        };

        const body = {
            name: document.getElementById('vName').value.trim(),
            capacity: parseInt(document.getElementById('vCapacity').value, 10),
            type: document.getElementById('vType').value,
            address
        };

        const url = id ? `${ctx()}/api/venues/${id}` : `${ctx()}/api/venues`;
        const method = id ? 'PUT' : 'POST';

        const r = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        if (!r.ok) {
            const txt = await r.text();
            alert(`save failed: ${r.status}\n${txt}`);
            return;
        }

        dlg.close('ok');
        reload();
    };

    function wsBase() {
        const proto = location.protocol === "https:" ? "wss:" : "ws:";
        return `${proto}//${location.host}${ctx()}`; // ctx() уже возвращает /ticket-is
    }

    let wsReloadTimer = null;

    function connectWsVenues() {
        const url = `${wsBase()}/ws/venues`;
        const ws = new WebSocket(url);

        ws.onopen = () => console.log("ws venues open", url);

        ws.onmessage = () => {
            clearTimeout(wsReloadTimer);
            wsReloadTimer = setTimeout(() => reload(), 120);
        };

        ws.onerror = () => {};
        ws.onclose = () => setTimeout(connectWsVenues, 2000);

        return ws;
    }

    async function init() {
        const ok = await ensureAuth();
        if (!ok) return;
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) logoutBtn.onclick = logout;
        document.getElementById('sortSel').value = state.sort;
        document.getElementById('orderSel').value = state.order;
        reload();
        connectWsVenues();
    }

    init();
</script>
</body>
</html>
