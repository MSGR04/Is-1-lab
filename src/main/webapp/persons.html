<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <title>Ticket IS Â· Persons</title>
    <style>
        :root{
            --bg:#f4f6fa; --card:#ffffff; --text:#101828; --muted:#667085; --border:#e6eaf2;
            --shadow:0 10px 30px rgba(16,24,40,.08); --shadow2:0 4px 14px rgba(16,24,40,.08);
            --radius:16px; --accent:#ffcc00; --danger:#ef4444; --focus:0 0 0 3px rgba(255,204,0,.35);
            --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        }
        *{ box-sizing:border-box; }
        body{ margin:0; font-family:var(--font); color:var(--text); background:var(--bg); }
        .app{ max-width: 1320px; margin:0 auto; padding:18px 16px 40px; }
        .topbar{
            display:flex; align-items:center; justify-content:space-between; gap:12px;
            padding:14px 16px; background:var(--card); border:1px solid var(--border);
            border-radius:var(--radius); box-shadow:var(--shadow2);
        }
        .brand{ display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px; }
        .brand-badge{ width:34px; height:34px; border-radius:10px; background:var(--accent); display:grid; place-items:center; font-weight:900; }
        .hint{ color:var(--muted); font-size:13px; }
        .nav{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
        .nav a{ text-decoration:none; color:var(--text); padding:10px 12px; border-radius:12px; border:1px solid transparent; }
        .nav a:hover{ background:#f8fafc; border-color:var(--border); }
        .nav a.active{ background:#111827; color:#fff; }
        .grid{ display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px; }
        .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow2); padding:14px; }
        .card-title{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
        .card-title h1{ font-size:18px; margin:0; }
        .row{ display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; }
        .field{ min-width:180px; display:flex; flex-direction:column; gap:6px; }
        .field label{ font-size:12px; color:var(--muted); }
        input, select, textarea{ width:100%; border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:#fff; outline:none; }
        input:focus, select:focus, textarea:focus{ box-shadow:var(--focus); border-color: rgba(255,204,0,.8); }
        .btn{
            border:1px solid var(--border); background:#fff; color:var(--text);
            padding:10px 12px; border-radius:12px; cursor:pointer;
        }
        .btn:hover{ background:#f8fafc; }
        .btn.primary{ background:var(--accent); border-color:rgba(0,0,0,.08); color:#111827; font-weight:700; }
        .btn.danger{ background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.25); color:var(--danger); }
        .pager{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
        .pill{ padding:8px 10px; border:1px solid var(--border); background:#fff; border-radius:999px; color:var(--muted); font-size:13px; }
        table{
            width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;
            border-radius:14px; border:1px solid var(--border);
        }
        thead th{
            position:sticky; top:0; background:#f8fafc; border-bottom:1px solid var(--border);
            font-size:12px; color:var(--muted); text-align:left; padding:10px 10px; cursor:pointer; user-select:none; white-space:nowrap;
        }
        tbody td{ padding:10px 10px; border-bottom:1px solid var(--border); font-size:13px; vertical-align:top; }
        tbody tr:nth-child(even){ background:#fcfdff; }
        tbody tr:hover{ background:#f6f8ff; }
        .actions{ display:flex; gap:8px; flex-wrap:wrap; }
        pre#log{ margin:0; color:var(--danger); font-size:12px; white-space:pre-wrap; }

        dialog{ border:none; border-radius:18px; padding:0; width:min(820px, calc(100% - 24px)); box-shadow:var(--shadow); }
        dialog::backdrop{ background:rgba(16,24,40,.35); backdrop-filter: blur(2px); }
        .dlg{ padding:14px; }
        .dlg-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 14px 10px; border-bottom:1px solid var(--border); }
        .dlg-head h3{ margin:0; font-size:16px; }
        .dlg-body{ padding:12px 14px 14px; }
        .dlg-foot{ padding:12px 14px 14px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; }
        .two{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        @media (max-width: 900px){ .two{ grid-template-columns:1fr; } .field{ min-width:140px; } }
    </style>
</head>
<body>
<div class="app">
    <div class="topbar">
        <div class="brand">
            <div class="brand-badge">T</div>
            <div>
                Ticket IS
                <div class="hint">Persons</div>
            </div>
        </div>
        <div class="nav">
            <a href="./index.html">Tickets</a>
            <a href="./venues.html">Venues</a>
            <a class="active" href="./persons.html">Persons</a>
            <a href="./events.html">Events</a>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <div class="card-title">
                <h1>Persons</h1>
                <button class="btn primary" id="createBtn">Create person</button>
            </div>

            <div class="row" style="justify-content: space-between; margin-bottom:10px;">
                <div class="pager">
                    <button class="btn" id="prevBtn">Prev</button>
                    <button class="btn" id="nextBtn">Next</button>
                    <span class="pill" id="pageInfo"></span>
                </div>

                <div class="row">
                    <div class="field" style="min-width:160px;">
                        <label>Sort</label>
                        <select id="sortSel">
                            <option value="id">id</option>
                            <option value="passportID">passportID</option>
                            <option value="nationality">nationality</option>
                        </select>
                    </div>
                    <div class="field" style="min-width:160px;">
                        <label>Order</label>
                        <select id="orderSel">
                            <option value="asc">asc</option>
                            <option value="desc">desc</option>
                        </select>
                    </div>
                    <div class="field" style="min-width:140px;">
                        <label>Page size</label>
                        <select id="pageSize">
                            <option>5</option>
                            <option selected>20</option>
                            <option>50</option>
                        </select>
                    </div>
                    <button class="btn" id="applyBtn">Apply</button>
                </div>
            </div>

            <table>
                <thead>
                <tr>
                    <th data-sort="id">id</th>
                    <th>eyeColor</th>
                    <th>hairColor</th>
                    <th>location (x,y,z)</th>
                    <th data-sort="passportID">passportID</th>
                    <th data-sort="nationality">nationality</th>
                    <th>actions</th>
                </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>

            <div style="margin-top:10px;">
                <pre id="log"></pre>
            </div>
        </div>
    </div>
</div>

<dialog id="editDlg">
    <div class="dlg">
        <div class="dlg-head">
            <h3 id="dlgTitle">Person</h3>
            <button class="btn" onclick="document.getElementById('editDlg').close('cancel')">Close</button>
        </div>

        <form method="dialog" id="editForm">
            <div class="dlg-body">
                <input type="hidden" id="pId">
                <div class="two">
                    <div class="field">
                        <label>eyeColor (optional)</label>
                        <select id="pEye">
                            <option value="">null</option>
                            <option>RED</option><option>YELLOW</option><option>ORANGE</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>hairColor (optional)</label>
                        <select id="pHair">
                            <option value="">null</option>
                            <option>RED</option><option>YELLOW</option><option>ORANGE</option>
                        </select>
                    </div>

                    <div class="field">
                        <label>passportID (max 35)</label>
                        <input id="pPassport" maxlength="35" required>
                    </div>
                    <div class="field">
                        <label>nationality</label>
                        <select id="pNat" required>
                            <option>GERMANY</option><option>SPAIN</option><option>INDIA</option><option>ITALY</option><option>JAPAN</option>
                        </select>
                    </div>

                    <div class="field">
                        <label>location.x (Float, required)</label>
                        <input id="pX" type="number" step="0.01" required>
                    </div>
                    <div class="field">
                        <label>location.y (float, required)</label>
                        <input id="pY" type="number" step="0.01" required>
                    </div>
                    <div class="field">
                        <label>location.z (Float, required)</label>
                        <input id="pZ" type="number" step="0.01" required>
                    </div>
                </div>
            </div>

            <div class="dlg-foot">
                <button class="btn" value="cancel">Cancel</button>
                <button class="btn primary" value="default">Save</button>
            </div>
        </form>
    </div>
</dialog>

<script>
    function ctx() {
        const p = location.pathname.split('/');
        return p.length > 1 ? '/' + p[1] : '';
    }

    const state = { page: 0, size: 20, sort: 'id', order: 'asc' };
    const log = (msg) => document.getElementById('log').textContent = msg;

    async function fetchPage() {
        const qs = new URLSearchParams();
        qs.set('page', state.page);
        qs.set('size', state.size);
        qs.set('sort', state.sort);
        qs.set('order', state.order);
        const url = `${ctx()}/api/persons?${qs.toString()}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
    }

    function render(pageDto) {
        const tb = document.getElementById('tbody');
        tb.innerHTML = '';
        for (const p of pageDto.items) {
            const loc = p.location ? `${p.location.x}, ${p.location.y}, ${p.location.z}` : '';
            const tr = document.createElement('tr');
            tr.innerHTML = `
        <td>${p.id}</td>
        <td>${p.eyeColor ?? ''}</td>
        <td>${p.hairColor ?? ''}</td>
        <td>${loc}</td>
        <td>${p.passportID}</td>
        <td>${p.nationality}</td>
        <td>
          <div class="actions">
            <button class="btn" data-act="edit" data-id="${p.id}">Edit</button>
            <button class="btn danger" data-act="del" data-id="${p.id}">Delete</button>
          </div>
        </td>
      `;
            tb.appendChild(tr);
        }
        document.getElementById('pageInfo').textContent =
            `page=${pageDto.page}, size=${pageDto.size}, total=${pageDto.total}`;
    }

    async function reload() {
        try {
            const data = await fetchPage();
            render(data);
            log('');
        } catch (e) {
            log(String(e));
        }
    }

    document.getElementById('prevBtn').onclick = () => { if (state.page > 0) state.page--; reload(); };
    document.getElementById('nextBtn').onclick = () => { state.page++; reload(); };
    document.getElementById('pageSize').onchange = (e) => { state.size = parseInt(e.target.value, 10); state.page = 0; reload(); };
    document.getElementById('applyBtn').onclick = () => {
        state.sort = document.getElementById('sortSel').value;
        state.order = document.getElementById('orderSel').value;
        state.page = 0;
        reload();
    };

    document.querySelectorAll('th[data-sort]').forEach(th => {
        th.onclick = () => {
            const s = th.getAttribute('data-sort');
            if (state.sort === s) state.order = (state.order === 'asc' ? 'desc' : 'asc');
            else { state.sort = s; state.order = 'asc'; }
            document.getElementById('sortSel').value = state.sort;
            document.getElementById('orderSel').value = state.order;
            reload();
        };
    });

    const dlg = document.getElementById('editDlg');
    function openDialog(p) {
        document.getElementById('pId').value = p?.id ?? '';
        document.getElementById('dlgTitle').textContent = p?.id ? `Edit person ${p.id}` : 'Create person';

        document.getElementById('pEye').value = p?.eyeColor ?? '';
        document.getElementById('pHair').value = p?.hairColor ?? '';
        document.getElementById('pPassport').value = p?.passportID ?? '';
        document.getElementById('pNat').value = p?.nationality ?? 'GERMANY';

        document.getElementById('pX').value = p?.location?.x ?? 0;
        document.getElementById('pY').value = p?.location?.y ?? 0;
        document.getElementById('pZ').value = p?.location?.z ?? 0;

        dlg.showModal();
    }

    document.getElementById('createBtn').onclick = () => openDialog(null);

    document.getElementById('tbody').onclick = async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-act');

        if (act === 'del') {
            if (!confirm(`Delete person ${id}?`)) return;

            let r = await fetch(`${ctx()}/api/persons/${id}`, { method: 'DELETE' });

            if (!r.ok) {
                const newId = prompt(`Person ${id} is used by tickets.\nEnter newPersonId to rebind tickets and delete:`);
                if (!newId) return;

                r = await fetch(`${ctx()}/api/persons/${id}/rebind-delete?newPersonId=${encodeURIComponent(newId)}`, {
                    method: 'POST'
                });

                if (!r.ok) alert(`rebind-delete failed: ${r.status}\n${await r.text()}`);
            }

            reload();
        }

        if (act === 'edit') {
            const r = await fetch(`${ctx()}/api/persons/${id}`);
            if (!r.ok) { alert(`load failed: ${r.status}`); return; }
            const p = await r.json();
            openDialog(p);
        }
    };

    document.getElementById('editForm').onsubmit = async () => {
        const id = document.getElementById('pId').value.trim();

        const eye = document.getElementById('pEye').value;
        const hair = document.getElementById('pHair').value;

        const body = {
            eyeColor: eye ? eye : null,
            hairColor: hair ? hair : null,
            location: {
                x: parseFloat(document.getElementById('pX').value),
                y: parseFloat(document.getElementById('pY').value),
                z: parseFloat(document.getElementById('pZ').value),
            },
            passportID: document.getElementById('pPassport').value.trim(),
            nationality: document.getElementById('pNat').value
        };

        const url = id ? `${ctx()}/api/persons/${id}` : `${ctx()}/api/persons`;
        const method = id ? 'PUT' : 'POST';

        const r = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        if (!r.ok) {
            const txt = await r.text();
            alert(`save failed: ${r.status}\n${txt}`);
            return;
        }

        dlg.close('ok');
        reload();
    };
    function wsBase() {
        const proto = location.protocol === "https:" ? "wss:" : "ws:";
        return `${proto}//${location.host}${ctx()}`;
    }

    let wsReloadTimer = null;

    function connectWsPersons() {
        const url = `${wsBase()}/ws/persons`;
        const ws = new WebSocket(url);

        ws.onopen = () => console.log("ws persons open", url);

        ws.onmessage = () => {
            clearTimeout(wsReloadTimer);
            wsReloadTimer = setTimeout(() => reload(), 120);
        };

        ws.onerror = () => {};
        ws.onclose = () => setTimeout(connectWsPersons, 2000);

        return ws;
    }

    document.getElementById('sortSel').value = state.sort;
    document.getElementById('orderSel').value = state.order;
    reload();
    connectWsPersons();
</script>
</body>
</html>
