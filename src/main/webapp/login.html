<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <title>Ticket IS - Login</title>
    <style>
        :root{
            --bg:#f4f6fa; --card:#ffffff; --text:#101828; --muted:#667085; --border:#c4cedd;
            --shadow:0 10px 30px rgba(16,24,40,.08); --radius:16px; --accent:#ffcc00;
            --danger:#ef4444; --focus:0 0 0 3px rgba(255,204,0,.35);
            --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        }
        *{ box-sizing:border-box; }
        body{ margin:0; font-family:var(--font); color:var(--text); background:var(--bg); }
        .wrap{ min-height:100vh; display:grid; place-items:center; padding:20px; }
        .card{
            width:min(780px, 100%); background:var(--card); border:1px solid var(--border);
            border-radius:var(--radius); box-shadow:var(--shadow); padding:18px;
        }
        .head{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
        h1{ margin:0; font-size:22px; }
        .hint{ color:var(--muted); font-size:13px; }
        .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
        .panel{ border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff; }
        .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
        .field label{ font-size:12px; color:var(--muted); }
        .field-msg{
            min-height:16px;
            font-size:12px;
            color:var(--danger);
        }
        .panel-msg{
            min-height:18px;
            font-size:12px;
            color:var(--danger);
            margin-bottom:8px;
        }
        input{
            width:100%;
            border:1px solid #a9b5c8;
            border-radius:12px;
            padding:10px 12px;
            outline:none;
            background:#fff;
        }
        input:focus{ box-shadow:var(--focus); border-color:#f0c419; }
        .row{ display:flex; gap:8px; align-items:center; }
        .btn{
            border:1px solid #9ca8bb;
            background:#fff;
            color:var(--text);
            padding:10px 12px; border-radius:12px; cursor:pointer;
        }
        .btn.primary{ background:var(--accent); border-color:#d0aa00; font-weight:700; }
    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <div class="head">
            <div>
                <h1>Ticket IS</h1>
                <div class="hint">Login or create an account</div>
            </div>
        </div>

        <div class="grid">
            <div class="panel">
                <h3>Login</h3>
                <div id="loginPanelMsg" class="panel-msg"></div>
                <div class="field">
                    <label>Username</label>
                    <div id="loginUserMsg" class="field-msg"></div>
                    <input id="loginUser" autocomplete="username" required maxlength="64">
                </div>
                <div class="field">
                    <label>Password</label>
                    <div id="loginPassMsg" class="field-msg"></div>
                    <input id="loginPass" type="password" autocomplete="current-password" required maxlength="128">
                </div>
                <div class="row">
                    <button class="btn primary" id="loginBtn" type="button">Login</button>
                </div>
            </div>

            <div class="panel">
                <h3>Register</h3>
                <div id="registerPanelMsg" class="panel-msg"></div>
                <div class="field">
                    <label>Username (3-64)</label>
                    <div id="regUserMsg" class="field-msg"></div>
                    <input id="regUser" autocomplete="username" required minlength="3" maxlength="64">
                </div>
                <div class="field">
                    <label>Password (6-128)</label>
                    <div id="regPassMsg" class="field-msg"></div>
                    <input id="regPass" type="password" autocomplete="new-password" required minlength="6" maxlength="128">
                </div>
                <div class="row">
                    <button class="btn" id="registerBtn" type="button">Create account</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function ctx() {
        const p = location.pathname.split('/');
        return p.length > 1 ? '/' + p[1] : '';
    }

    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    const regUser = document.getElementById('regUser');
    const regPass = document.getElementById('regPass');
    const loginUserMsg = document.getElementById('loginUserMsg');
    const loginPassMsg = document.getElementById('loginPassMsg');
    const regUserMsg = document.getElementById('regUserMsg');
    const regPassMsg = document.getElementById('regPassMsg');
    const loginPanelMsg = document.getElementById('loginPanelMsg');
    const registerPanelMsg = document.getElementById('registerPanelMsg');

    function setMsg(el, msg) {
        el.textContent = msg || '';
    }

    function clearLoginMsgs() {
        setMsg(loginUserMsg, '');
        setMsg(loginPassMsg, '');
        setMsg(loginPanelMsg, '');
    }

    function clearRegisterMsgs() {
        setMsg(regUserMsg, '');
        setMsg(regPassMsg, '');
        setMsg(registerPanelMsg, '');
    }

    [loginUser, loginPass].forEach((el) => el.addEventListener('input', clearLoginMsgs));
    [regUser, regPass].forEach((el) => el.addEventListener('input', clearRegisterMsgs));

    async function checkLoggedIn() {
        const r = await fetch(`${ctx()}/api/auth/me`);
        if (r.ok) location.href = `${ctx()}/index.html`;
    }

    async function sendJson(url, body) {
        const r = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const text = await r.text();
        if (!r.ok) throw new Error(text || `HTTP ${r.status}`);
        return text ? JSON.parse(text) : null;
    }

    function escRe(s) {
        return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function extractParamMessage(rawText, key) {
        const re = new RegExp(`\\[${escRe(key)}\\]\\[([^\\]]+)\\]`);
        const m = rawText.match(re);
        return m ? m[1] : null;
    }

    function showValidationErrorsAtFields(rawText, scope) {
        const text = String(rawText || '');
        const items = scope === 'register'
            ? [
                { key: 'register.arg0.username', msgEl: regUserMsg },
                { key: 'register.arg0.password', msgEl: regPassMsg }
            ]
            : [
                { key: 'login.arg0.username', msgEl: loginUserMsg },
                { key: 'login.arg0.password', msgEl: loginPassMsg }
            ];

        let handled = false;
        for (const it of items) {
            const msg = extractParamMessage(text, it.key);
            if (msg) {
                setMsg(it.msgEl, msg);
                handled = true;
            }
        }
        return handled;
    }

    function validateRegister() {
        clearRegisterMsgs();
        let ok = true;
        regUser.value = regUser.value.trim();
        regPass.value = regPass.value.trim();

        if (!regUser.value) {
            setMsg(regUserMsg, 'Введите username');
            ok = false;
        } else if (regUser.value.length < 3 || regUser.value.length > 64) {
            setMsg(regUserMsg, 'Длина username должна быть 3..64');
            ok = false;
        }

        if (!regPass.value) {
            setMsg(regPassMsg, 'Введите пароль');
            ok = false;
        } else if (regPass.value.length < 6 || regPass.value.length > 128) {
            setMsg(regPassMsg, 'Длина пароля должна быть 6..128');
            ok = false;
        }
        return ok;
    }

    function validateLogin() {
        clearLoginMsgs();
        let ok = true;
        loginUser.value = loginUser.value.trim();
        loginPass.value = loginPass.value.trim();

        if (!loginUser.value) {
            setMsg(loginUserMsg, 'Введите username');
            ok = false;
        }
        if (!loginPass.value) {
            setMsg(loginPassMsg, 'Введите пароль');
            ok = false;
        }
        return ok;
    }

    document.getElementById('registerBtn').onclick = async () => {
        try {
            if (!validateRegister()) return;
            const username = regUser.value;
            const password = regPass.value;
            await sendJson(`${ctx()}/api/auth/register`, { username, password });
            setMsg(registerPanelMsg, 'Аккаунт создан. Теперь войдите.');
        } catch (e) {
            const msg = String(e);
            if (msg.includes('username already exists')) {
                setMsg(regUserMsg, 'Такой username уже существует');
                return;
            }
            if (!showValidationErrorsAtFields(msg, 'register')) {
                setMsg(registerPanelMsg, 'Ошибка регистрации');
            }
        }
    };

    document.getElementById('loginBtn').onclick = async () => {
        try {
            if (!validateLogin()) return;
            const username = loginUser.value;
            const password = loginPass.value;
            await sendJson(`${ctx()}/api/auth/login`, { username, password });
            location.href = `${ctx()}/index.html`;
        } catch (e) {
            const msg = String(e);
            if (msg.includes('invalid credentials') || msg.includes('unauthorized')) {
                setMsg(loginPassMsg, 'Неверный логин или пароль');
                return;
            }
            if (!showValidationErrorsAtFields(msg, 'login')) {
                setMsg(loginPanelMsg, 'Ошибка входа');
            }
        }
    };

    checkLoggedIn();
</script>
</body>
</html>
